name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # Confirmation check
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "âŒ Confirmation failed. You must type 'deploy' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation validated"

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    environment: production

    steps:
      # ============================================
      # 1. Checkout and Setup
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # Cache infrastructure node_modules separately
      - name: Cache infrastructure dependencies
        uses: actions/cache@v4
        with:
          path: infrastructure/node_modules
          key: ${{ runner.os }}-infra-${{ hashFiles('infrastructure/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-infra-

      # Cache CDKTF provider bindings (significant time saver)
      - name: Cache CDKTF provider bindings
        uses: actions/cache@v4
        with:
          path: infrastructure/imports
          key: ${{ runner.os }}-cdktf-imports-${{ hashFiles('infrastructure/cdktf.json', 'infrastructure/package.json') }}
          restore-keys: |
            ${{ runner.os }}-cdktf-imports-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      # ============================================
      # 2. Authenticate to GCP
      # ============================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # ============================================
      # 3. Deploy Infrastructure with CDKTF
      # ============================================
      - name: Install CDKTF CLI
        run: pnpm install -g cdktf-cli@^0.20.0

      - name: Install infrastructure dependencies
        working-directory: ./infrastructure
        run: |
          if [ -d "node_modules" ] && [ -n "$(ls -A node_modules 2>/dev/null)" ]; then
            echo "âœ“ Infrastructure dependencies restored from cache"
            pnpm install --prefer-offline --frozen-lockfile
          else
            echo "Installing infrastructure dependencies..."
            pnpm install --frozen-lockfile
          fi

      - name: Generate CDKTF provider bindings
        working-directory: ./infrastructure
        run: |
          if [ -d "imports" ] && [ -n "$(ls -A imports 2>/dev/null)" ]; then
            echo "âœ“ CDKTF provider bindings restored from cache"
          else
            echo "Generating CDKTF provider bindings..."
            pnpm run get
          fi

      - name: Create infrastructure .env file
        working-directory: ./infrastructure
        run: |
          cat > .env << EOF
          GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION=${{ secrets.GCP_REGION }}
          GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}
          GCS_BUCKET_LOCATION=${{ secrets.GCS_BUCKET_LOCATION }}
          ENVIRONMENT=production
          DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
          EOF

      - name: CDKTF Synth
        working-directory: ./infrastructure
        run: pnpm run synth

      - name: Import existing bucket if needed
        working-directory: ./infrastructure
        run: |
          # Check if bucket exists
          if gcloud storage buckets describe "gs://${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}" &>/dev/null; then
            echo "Bucket exists, checking if it's in state..."

            # Initialize Terraform backend
            cd cdktf.out/stacks/dcmco-website-storage
            terraform init

            # Check if bucket is already in state
            if ! terraform state list | grep -q "google_storage_bucket.website-bucket"; then
              echo "Importing existing bucket into Terraform state..."
              terraform import google_storage_bucket.website-bucket "${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}"
              echo "âœ“ Bucket imported successfully"
            else
              echo "âœ“ Bucket already in state"
            fi

            cd ../../..
          else
            echo "Bucket doesn't exist yet, will be created by deploy"
          fi

      - name: CDKTF Deploy
        working-directory: ./infrastructure
        run: cdktf deploy --auto-approve

      # ============================================
      # 4. Build Next.js Site
      # ============================================
      # Cache Next.js build output
      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            out/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx', '!**/node_modules/**') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-

      - name: Configure npm authentication for Artifact Registry
        run: |
          # Generate auth token using gcloud
          TOKEN=$(gcloud auth print-access-token)

          # Create .npmrc with scope configuration and auth token
          cat > .npmrc << EOF
          @dcmco:registry=https://australia-southeast1-npm.pkg.dev/dcmco-prod-2026/npm-packages/
          //australia-southeast1-npm.pkg.dev/dcmco-prod-2026/npm-packages/:always-auth=true
          //australia-southeast1-npm.pkg.dev/dcmco-prod-2026/npm-packages/:_authToken=${TOKEN}
          EOF

          # Verify .npmrc configuration
          echo "=== .npmrc contents ==="
          cat .npmrc
          echo "======================="

      - name: Install website dependencies
        run: |
          # Note: pnpm cache is already handled by setup-node cache: 'pnpm'
          echo "Installing website dependencies..."
          pnpm install --frozen-lockfile --prefer-offline

      - name: Build Next.js site
        run: pnpm run build
        env:
          NEXT_PUBLIC_ENV: production

      # ============================================
      # 5. Deploy to GCS
      # ============================================
      - name: Upload to GCS
        run: |
          echo "Uploading static site to gs://${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}/"
          gsutil -m rsync -r -d out/ gs://${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}/

      - name: Set Cache-Control headers
        env:
          BUCKET: gs://${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}
        run: |
          echo "Setting cache-control headers for different file types..."
          echo "Note: More specific patterns are applied last to override general patterns"
          echo ""

          # 1. HTML files - Always revalidate (0 seconds)
          echo "â†’ HTML files: max-age=0, must-revalidate"
          gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" \
            "${BUCKET}/**/*.html" 2>/dev/null || echo "  No HTML files found"

          # 2. CSS and JS (general) - Cache for 1 hour (3600 seconds)
          echo "â†’ CSS/JS files (general): max-age=3600 (1 hour)"
          gsutil -m setmeta -h "Cache-Control:public, max-age=3600" \
            "${BUCKET}/**/*.css" "${BUCKET}/**/*.js" 2>/dev/null || echo "  No CSS/JS files found"

          # 3. JSON files - Cache for 1 hour
          echo "â†’ JSON files: max-age=3600 (1 hour)"
          gsutil -m setmeta -h "Cache-Control:public, max-age=3600" \
            "${BUCKET}/**/*.json" 2>/dev/null || echo "  No JSON files found"

          # 4. Images - Cache for 30 days (2592000 seconds)
          echo "â†’ Images: max-age=2592000 (30 days)"
          gsutil -m setmeta -h "Cache-Control:public, max-age=2592000" \
            "${BUCKET}/**/*.png" "${BUCKET}/**/*.jpg" "${BUCKET}/**/*.jpeg" \
            "${BUCKET}/**/*.svg" "${BUCKET}/**/*.webp" "${BUCKET}/**/*.gif" \
            "${BUCKET}/**/*.ico" 2>/dev/null || echo "  No image files found"

          # 5. Fonts - Cache for 1 year (immutable)
          echo "â†’ Fonts: max-age=31536000, immutable"
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            "${BUCKET}/**/*.woff" "${BUCKET}/**/*.woff2" "${BUCKET}/**/*.ttf" \
            "${BUCKET}/**/*.otf" "${BUCKET}/**/*.eot" 2>/dev/null || echo "  No font files found"

          # 6. Next.js hashed static assets - Cache forever (1 year) - MUST BE LAST
          echo "â†’ Next.js hashed assets: max-age=31536000, immutable (overriding general CSS/JS)"
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            "${BUCKET}/_next/static/**" 2>/dev/null || echo "  No Next.js static assets found"

          echo "âœ“ Cache headers set successfully"

      # ============================================
      # 6. Verification
      # ============================================
      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed successfully!"

          # Check if custom domain is configured
          if [ -n "${{ secrets.DOMAIN_NAME }}" ]; then
            echo "ðŸŒ Production URL: https://${{ secrets.DOMAIN_NAME }}"
          else
            echo "ðŸŒ Production URL: https://storage.googleapis.com/${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}/index.html"
          fi

          # Test if index.html is accessible
          curl -f -s -o /dev/null https://storage.googleapis.com/${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}/index.html || \
            (echo "âŒ Website is not accessible" && exit 1)

          echo "âœ… Website is accessible and serving content"

      # ============================================
      # 7. CDN Cache Invalidation (if configured)
      # ============================================
      - name: Invalidate CDN cache
        if: ${{ vars.CDN_URL_MAP != '' }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Invalidating CDN cache..."
          echo "CDN URL Map: ${{ vars.CDN_URL_MAP }}"

          # Invalidate all paths in the CDN
          gcloud compute url-maps invalidate-cdn-cache "${{ vars.CDN_URL_MAP }}" \
            --path "/*" \
            --async \
            --quiet || {
              echo "âš ï¸  CDN cache invalidation failed, but continuing deployment"
              echo "This is not critical - cache will expire naturally"
              exit 0
            }

          echo "âœ“ CDN cache invalidation started (running asynchronously)"
          echo "Note: Cache invalidation may take a few minutes to complete"

      - name: Skip CDN invalidation
        if: ${{ vars.CDN_URL_MAP == '' }}
        run: |
          echo "â„¹ï¸  No CDN configured (CDN_URL_MAP not set)"
          echo "Skipping cache invalidation step"

      # ============================================
      # 8. Enhanced Deployment Summary
      # ============================================
      - name: Deployment Summary
        if: always()
        env:
          BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          BUCKET_REGION: ${{ secrets.GCS_BUCKET_LOCATION }}
          DOMAIN: ${{ secrets.DOMAIN_NAME }}
        run: |
          # Calculate deployment duration
          WORKFLOW_START="${{ github.event.repository.updated_at }}"
          DEPLOY_END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Get file count and total size from GCS bucket
          FILE_COUNT=$(gsutil ls -r "gs://${BUCKET_NAME}/**" 2>/dev/null | grep -v ':$' | wc -l || echo "0")
          TOTAL_SIZE=$(gsutil du -s "gs://${BUCKET_NAME}" 2>/dev/null | awk '{print $1}' || echo "0")

          # Convert bytes to human-readable format
          if [ "$TOTAL_SIZE" -ge 1073741824 ]; then
            SIZE_FORMATTED="$(awk "BEGIN {printf \"%.2f GB\", $TOTAL_SIZE/1073741824}")"
          elif [ "$TOTAL_SIZE" -ge 1048576 ]; then
            SIZE_FORMATTED="$(awk "BEGIN {printf \"%.2f MB\", $TOTAL_SIZE/1048576}")"
          else
            SIZE_FORMATTED="$(awk "BEGIN {printf \"%.2f KB\", $TOTAL_SIZE/1024}")"
          fi

          # Build deployment summary
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Deployment Status
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Status: Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Environment Details
          echo "### ðŸ“¦ Environment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | **Production** âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          echo "| GCP Project | \`${PROJECT_ID}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Bucket | \`${BUCKET_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${BUCKET_REGION}\` |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${DOMAIN}" ]; then
            echo "| Domain | \`${DOMAIN}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Deployment Metrics
          echo "### ðŸ“Š Deployment Metrics" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Files | **${FILE_COUNT}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Size | **${SIZE_FORMATTED}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed At | \`${DEPLOY_END}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Links Section
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          if [ -n "${DOMAIN}" ]; then
            echo "- ðŸŒ [Production Website](https://${DOMAIN})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸŒ [Direct GCS Link](https://storage.googleapis.com/${BUCKET_NAME}/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸª£ [GCS Bucket Console](https://console.cloud.google.com/storage/browser/${BUCKET_NAME})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ [Commit Details](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # CDN Status (if configured)
          if [ -n "${{ vars.CDN_URL_MAP }}" ]; then
            echo "### ðŸŒ CDN Status" >> $GITHUB_STEP_SUMMARY
            echo "- CDN cache invalidation initiated for \`${{ vars.CDN_URL_MAP }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Invalidation may take a few minutes to propagate" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Cache Summary
          echo "### âš¡ Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Incremental deployment using \`gsutil rsync\`" >> $GITHUB_STEP_SUMMARY
          echo "- Optimized cache headers applied" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies cached for faster subsequent runs" >> $GITHUB_STEP_SUMMARY

