# name: Deploy Infrastructure - Staging

# # ============================================================================
# # Trigger: Deploy to staging on merge to main
# # ============================================================================
# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'infrastructure/**'
#       - '.github/workflows/cdktf-*.yml'
#   workflow_dispatch: # Allow manual triggering

# # ============================================================================
# # Security: Least-privilege GITHUB_TOKEN permissions
# # ============================================================================
# permissions:
#   id-token: write # Required for OIDC authentication to GCP
#   contents: read  # Required for checkout

# # ============================================================================
# # Prevent concurrent deployments to staging
# # ============================================================================
# concurrency:
#   group: cdktf-deploy-staging
#   cancel-in-progress: false # Don't cancel in-progress deployments

# env:
#   # Node.js and CDKTF versions
#   NODE_VERSION: '20'
#   PNPM_VERSION: '9'
#   TERRAFORM_VERSION: '1.7.0'
#   CDKTF_VERSION: '0.20.0'

#   # GCP Configuration
#   GCP_PROJECT_ID: dcmco-prod-2026
#   GCP_REGION: australia-southeast1
#   WORKLOAD_IDENTITY_PROVIDER: 'projects/254813336446/locations/global/workloadIdentityPools/github-actions/providers/github-oidc'
#   SERVICE_ACCOUNT: 'github-actions@dcmco-prod-2026.iam.gserviceaccount.com'

#   # Environment
#   ENVIRONMENT: staging
#   GCS_BUCKET_NAME: dcmco-website-staging

# jobs:
#   deploy-staging:
#     name: Deploy to Staging
#     runs-on: ubuntu-latest
#     environment:
#       name: staging
#       url: https://dcmco-staging.web.app

#     steps:
#       # ================================================================
#       # Checkout Code
#       # ================================================================
#       - name: Checkout repository
#         uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

#       # ================================================================
#       # Authenticate to GCP using Workload Identity Federation (OIDC)
#       # ================================================================
#       - name: Authenticate to Google Cloud
#         id: auth
#         uses: google-github-actions/auth@62cf5bd3e4211a0a0b51f2c6d6a37129d828611d # v2.1.5
#         with:
#           workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
#           service_account: ${{ env.SERVICE_ACCOUNT }}
#           token_format: 'access_token'
#           access_token_lifetime: '3600s'
#           create_credentials_file: true

#       - name: Set up Cloud SDK
#         uses: google-github-actions/setup-gcloud@f0990588f1e5b5af6827153b93673613abdc6ec7 # v2.1.1

#       # ================================================================
#       # Setup Node.js with caching
#       # ================================================================
#       - name: Setup Node.js
#         uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
#         with:
#           node-version: ${{ env.NODE_VERSION }}

#       # ================================================================
#       # Setup pnpm with caching
#       # ================================================================
#       - name: Install pnpm
#         uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
#         with:
#           version: ${{ env.PNPM_VERSION }}
#           run_install: false

#       - name: Get pnpm store directory
#         id: pnpm-cache
#         shell: bash
#         run: |
#           echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

#       - name: Setup pnpm cache
#         uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
#         with:
#           path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
#           key: ${{ runner.os }}-pnpm-store-${{ hashFiles('infrastructure/pnpm-lock.yaml') }}
#           restore-keys: |
#             ${{ runner.os }}-pnpm-store-

#       # ================================================================
#       # Setup Terraform
#       # ================================================================
#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
#         with:
#           terraform_version: ${{ env.TERRAFORM_VERSION }}
#           terraform_wrapper: false

#       # ================================================================
#       # Install CDKTF CLI
#       # ================================================================
#       - name: Install CDKTF CLI
#         run: npm install -g cdktf-cli@${{ env.CDKTF_VERSION }}

#       # ================================================================
#       # Install dependencies
#       # ================================================================
#       - name: Install infrastructure dependencies
#         working-directory: ./infrastructure
#         run: pnpm install --frozen-lockfile

#       # ================================================================
#       # Cache CDKTF provider bindings (.gen directory)
#       # ================================================================
#       - name: Cache CDKTF provider bindings
#         uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
#         with:
#           path: infrastructure/.gen
#           key: ${{ runner.os }}-cdktf-gen-${{ hashFiles('infrastructure/cdktf.json', 'infrastructure/package.json') }}
#           restore-keys: |
#             ${{ runner.os }}-cdktf-gen-

#       # ================================================================
#       # Generate provider bindings manually (post-December 2025)
#       # Google prebuilt bindings were sunset - must generate locally
#       # ================================================================
#       - name: Generate Google Cloud provider bindings
#         working-directory: ./infrastructure
#         run: |
#           echo "ðŸ“¦ Generating Google Cloud provider bindings locally..."
#           echo "Note: Prebuilt @cdktf/provider-google was sunset in Dec 2025"

#           # Remove old prebuilt provider if it exists
#           pnpm remove @cdktf/provider-google 2>/dev/null || true

#           # Generate bindings from Terraform registry
#           cdktf get

#           echo "âœ… Provider bindings generated successfully"

#       # ================================================================
#       # Ensure secrets exist in Secret Manager
#       # ================================================================
#       - name: Ensure SendGrid secret exists in Secret Manager
#         env:
#           SENDGRID_KEY: ${{ secrets.SENDGRID_API_KEY_STAGING }}
#         run: |
#           SECRET_ID="dcmco-website-${{ env.ENVIRONMENT }}-sendgrid-api-key"

#           # Check if secret exists
#           if ! gcloud secrets describe $SECRET_ID --project=${{ env.GCP_PROJECT_ID }} 2>/dev/null; then
#             echo "Creating secret $SECRET_ID"
#             gcloud secrets create $SECRET_ID --project=${{ env.GCP_PROJECT_ID }}
#           fi

#           # Add/update secret version
#           echo -n "${SENDGRID_KEY}" | gcloud secrets versions add $SECRET_ID \
#             --project=${{ env.GCP_PROJECT_ID }} \
#             --data-file=-

#           echo "âœ… Secret $SECRET_ID is up to date"

#       # ================================================================
#       # Build and package Cloud Function
#       # ================================================================
#       - name: Build Cloud Function source code
#         working-directory: ./functions/contact-form
#         run: |
#           echo "ðŸ“¦ Building Cloud Function..."
#           npm install --production
#           npm run build

#       - name: Package Cloud Function for deployment
#         working-directory: ./functions/contact-form
#         run: |
#           echo "ðŸ“¦ Creating function deployment package..."
#           # Create a clean package with only dist, package.json, and node_modules
#           zip -r ../../infrastructure/function-source.zip \
#             dist/ \
#             package.json \
#             node_modules/

#           echo "âœ… Function package created at infrastructure/function-source.zip"
#           ls -lh ../../infrastructure/function-source.zip

#       # ================================================================
#       # Create environment configuration
#       # ================================================================
#       - name: Create infrastructure .env file
#         working-directory: ./infrastructure
#         run: |
#           cat > .env << EOF
#           GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}
#           GCP_REGION=${{ env.GCP_REGION }}
#           ENVIRONMENT=${{ env.ENVIRONMENT }}
#           GCS_BUCKET_NAME=${{ env.GCS_BUCKET_NAME }}
#           SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY_STAGING }}
#           EMAIL_RECIPIENT=shanesrf@gmail.com
#           FROM_EMAIL=shanesrf@gmail.com
#           ALLOWED_ORIGINS=http://localhost:3000,https://dcmco-staging.web.app
#           EOF

#       # ================================================================
#       # Synthesize CDKTF
#       # ================================================================
#       - name: CDKTF Synth
#         working-directory: ./infrastructure
#         run: |
#           echo "ðŸ”¨ Synthesizing CDKTF configuration..."
#           pnpm run synth

#       # ================================================================
#       # Deploy infrastructure with CDKTF
#       # ================================================================
#       - name: Deploy infrastructure to staging
#         id: deploy
#         working-directory: ./infrastructure
#         run: |
#           echo "ðŸš€ Deploying infrastructure to staging..."

#           # Deploy all stacks with auto-approval
#           cdktf deploy '*' --auto-approve

#           echo "âœ… Infrastructure deployed successfully to staging"
#           echo "deployment_status=success" >> $GITHUB_OUTPUT

#       # ================================================================
#       # Verify deployment
#       # ================================================================
#       - name: Verify infrastructure deployment
#         working-directory: ./infrastructure
#         run: |
#           echo "ðŸ” Verifying infrastructure deployment..."

#           # Run verification script if it exists
#           if [ -f "verify.sh" ]; then
#             bash verify.sh
#           else
#             echo "No verification script found, skipping..."
#           fi

#           echo "âœ… Verification complete"

#       # ================================================================
#       # Upload Terraform state info (for debugging)
#       # ================================================================
#       - name: Upload deployment artifacts
#         if: always()
#         uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
#         with:
#           name: staging-deployment-${{ github.run_number }}
#           path: |
#             infrastructure/cdktf.out/**/*.tf.json
#             infrastructure/cdktf.out/**/plan
#           retention-days: 30

#       # ================================================================
#       # Notify on failure
#       # ================================================================
#       - name: Notify on deployment failure
#         if: failure()
#         run: |
#           echo "âŒ Staging deployment failed!"
#           echo "Check the workflow logs for details."
#           echo "Commit: ${{ github.sha }}"
#           echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

#   # ============================================================================
#   # Post-deployment: Notify success
#   # ============================================================================
#   notify-success:
#     name: Notify Deployment Success
#     runs-on: ubuntu-latest
#     needs: deploy-staging
#     if: success()

#     steps:
#       - name: Deployment summary
#         run: |
#           echo "## ðŸŽ‰ Staging Deployment Successful" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
#           echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
#           echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
#           echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
#           echo "- Storage Stack (GCS buckets)" >> $GITHUB_STEP_SUMMARY
#           echo "- Functions Stack (Cloud Functions)" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
#           echo "- Test the staging environment: https://dcmco-staging.web.app" >> $GITHUB_STEP_SUMMARY
#           echo "- When ready, deploy to production (requires approval)" >> $GITHUB_STEP_SUMMARY
